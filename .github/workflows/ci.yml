name: CI - Build, Test & Lighthouse

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Annule les runs précédents sur la même branche/PR
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # JOB 1: Build + TypeCheck + Lint
  # Si ça échoue, rien d'autre ne tourne
  # ============================================
  build:
    name: Build & TypeCheck
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: TypeCheck
        run: npx tsc -b

      - name: Lint
        run: npx eslint . --max-warnings=0
        continue-on-error: true

      - name: Build
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            dist/
            build/
          retention-days: 1

  # ============================================
  # JOB 2: Bundle Size Check
  # Alerte si le bundle grossit trop
  # ============================================
  bundle-size:
    name: Bundle Size
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Analyze bundle size
        run: |
          echo "## Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Detect output directory (RSC: build/client, SPA: dist)
          if [ -d "build/client/assets" ]; then
            ASSETS_DIR="build/client/assets"
            TOTAL_DIR="build/client"
            echo "- **Build mode:** RSC (build/client)" >> $GITHUB_STEP_SUMMARY
          elif [ -d "dist/assets" ]; then
            ASSETS_DIR="dist/assets"
            TOTAL_DIR="dist"
            echo "- **Build mode:** SPA (dist)" >> $GITHUB_STEP_SUMMARY
          else
            echo "::error::No build output found"
            exit 1
          fi

          # Total JS size
          JS_SIZE=$(find "$ASSETS_DIR" -name '*.js' -exec wc -c {} + | tail -1 | awk '{print $1}')
          JS_SIZE_KB=$((JS_SIZE / 1024))
          echo "- **Total JS:** ${JS_SIZE_KB} KB" >> $GITHUB_STEP_SUMMARY

          # Total CSS size
          CSS_SIZE=$(find "$ASSETS_DIR" -name '*.css' -exec wc -c {} + | tail -1 | awk '{print $1}')
          CSS_SIZE_KB=$((CSS_SIZE / 1024))
          echo "- **Total CSS:** ${CSS_SIZE_KB} KB" >> $GITHUB_STEP_SUMMARY

          # Total assets
          TOTAL_SIZE=$(find "$TOTAL_DIR" -type f -exec wc -c {} + | tail -1 | awk '{print $1}')
          TOTAL_SIZE_KB=$((TOTAL_SIZE / 1024))
          echo "- **Total assets:** ${TOTAL_SIZE_KB} KB" >> $GITHUB_STEP_SUMMARY

          # Number of JS chunks
          JS_COUNT=$(find "$ASSETS_DIR" -name '*.js' | wc -l)
          echo "- **JS chunks:** ${JS_COUNT}" >> $GITHUB_STEP_SUMMARY

          # Top 5 biggest chunks
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Top 5 biggest chunks" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find "$ASSETS_DIR" -name '*.js' -exec ls -lhS {} + | head -5 | awk '{print $5, $NF}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Budget: client JS must stay under 1000KB (Phase 7 target)
          BUDGET_KB=1000
          if [ "$JS_SIZE_KB" -gt "$BUDGET_KB" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### BUDGET EXCEEDED" >> $GITHUB_STEP_SUMMARY
            echo "JS bundle (${JS_SIZE_KB} KB) exceeds budget (${BUDGET_KB} KB)" >> $GITHUB_STEP_SUMMARY
            echo "::error::JS bundle size ${JS_SIZE_KB}KB exceeds budget ${BUDGET_KB}KB"
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Budget OK (${JS_SIZE_KB}/${BUDGET_KB} KB)" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # JOB 3: Lighthouse CI
  # Performance, Accessibility, Best Practices, SEO
  # ============================================
  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: lighthouserc.json
          uploadArtifacts: true
          temporaryPublicStorage: true

  # ============================================
  # JOB 4: Lighthouse CI Mobile
  # Mobile-specific performance audit
  # ============================================
  lighthouse-mobile:
    name: Lighthouse Mobile
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Run Lighthouse CI Mobile
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: lighthouserc-mobile.json
          uploadArtifacts: true
          temporaryPublicStorage: true
