name: CI - Build, Test & Lighthouse

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Annule les runs precedents sur la meme branche/PR
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # JOB 1: Build + TypeCheck + Lint (BLOQUANT)
  # Si ca echoue, rien d'autre ne tourne
  # ============================================
  build:
    name: Build & TypeCheck & Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: TypeCheck
        run: npx tsc -b

      - name: Lint (non-bloquant — 572 erreurs préexistantes à corriger progressivement)
        run: npx eslint . --max-warnings=13000
        continue-on-error: true

      - name: Build
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            dist/
            build/
          retention-days: 1

  # ============================================
  # JOB 2: Unit Tests (Vitest avec sharding)
  # 5000+ tests repartis sur 4 shards paralleles
  # ============================================
  unit-tests:
    name: Unit Tests (shard ${{ matrix.shard }}/4)
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests (shard ${{ matrix.shard }}/4)
        run: npx vitest run --reporter=verbose --shard=${{ matrix.shard }}/4

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results-shard-${{ matrix.shard }}
          path: test-results/
          retention-days: 7

  # ============================================
  # JOB 3: Bundle Size Check
  # Budget: JS < 1000KB (bloquant)
  # ============================================
  bundle-size:
    name: Bundle Size
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Analyze bundle size
        run: |
          echo "## Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Detect output directory
          if [ -d "build/client/assets" ]; then
            ASSETS_DIR="build/client/assets"
            TOTAL_DIR="build/client"
            echo "- **Build mode:** SSR (build/client)" >> $GITHUB_STEP_SUMMARY
          elif [ -d "dist/assets" ]; then
            ASSETS_DIR="dist/assets"
            TOTAL_DIR="dist"
            echo "- **Build mode:** SPA (dist)" >> $GITHUB_STEP_SUMMARY
          else
            echo "::error::No build output found"
            exit 1
          fi

          # Total JS size
          JS_SIZE=$(find "$ASSETS_DIR" -name '*.js' -exec wc -c {} + | tail -1 | awk '{print $1}')
          JS_SIZE_KB=$((JS_SIZE / 1024))
          echo "- **Total JS:** ${JS_SIZE_KB} KB" >> $GITHUB_STEP_SUMMARY

          # Total CSS size
          CSS_SIZE=$(find "$ASSETS_DIR" -name '*.css' -exec wc -c {} + | tail -1 | awk '{print $1}')
          CSS_SIZE_KB=$((CSS_SIZE / 1024))
          echo "- **Total CSS:** ${CSS_SIZE_KB} KB" >> $GITHUB_STEP_SUMMARY

          # Total assets
          TOTAL_SIZE=$(find "$TOTAL_DIR" -type f -exec wc -c {} + | tail -1 | awk '{print $1}')
          TOTAL_SIZE_KB=$((TOTAL_SIZE / 1024))
          echo "- **Total assets:** ${TOTAL_SIZE_KB} KB" >> $GITHUB_STEP_SUMMARY

          # Number of JS chunks
          JS_COUNT=$(find "$ASSETS_DIR" -name '*.js' | wc -l)
          echo "- **JS chunks:** ${JS_COUNT}" >> $GITHUB_STEP_SUMMARY

          # Top 5 biggest chunks
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Top 5 biggest chunks" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find "$ASSETS_DIR" -name '*.js' -exec ls -lhS {} + | head -5 | awk '{print $5, $NF}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Budget: client JS must stay under 1000KB
          BUDGET_KB=1000
          if [ "$JS_SIZE_KB" -gt "$BUDGET_KB" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### :x: BUDGET EXCEEDED" >> $GITHUB_STEP_SUMMARY
            echo "JS bundle (${JS_SIZE_KB} KB) exceeds budget (${BUDGET_KB} KB)" >> $GITHUB_STEP_SUMMARY
            echo "::error::JS bundle size ${JS_SIZE_KB}KB exceeds budget ${BUDGET_KB}KB"
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo ":white_check_mark: Budget OK (${JS_SIZE_KB}/${BUDGET_KB} KB)" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # JOB 4: Lighthouse CI Desktop
  # Perf 95+, A11y 100, BP 95+, SEO 95+
  # ============================================
  lighthouse:
    name: Lighthouse Desktop
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Run Lighthouse CI Desktop
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: lighthouserc.json
          uploadArtifacts: true
          temporaryPublicStorage: true

  # ============================================
  # JOB 5: Lighthouse CI Mobile
  # Perf 90+, A11y 100, BP 90+, SEO 90+
  # ============================================
  lighthouse-mobile:
    name: Lighthouse Mobile
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Run Lighthouse CI Mobile
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: lighthouserc-mobile.json
          uploadArtifacts: true
          temporaryPublicStorage: true

  # ============================================
  # JOB 6: E2E Tests (Playwright - Chromium)
  # 192 tests contre production
  # ============================================
  e2e:
    name: E2E Tests (Chromium)
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Run E2E tests
        run: npx playwright test --project=chromium
        env:
          CI: true
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          E2E_TEST_EMAIL: ${{ secrets.E2E_TEST_EMAIL }}
          E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD }}

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results
          path: test-results/
          retention-days: 7
